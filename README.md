# Flutter Chat Composer

>How about transforming your state machine in a chat bot? Flutter Chat Composer makes use of state machines generated by <a href="https://github.com/FelipeMarra/state-composer">state_composer<a> to create chatbots based on those states

# Usage

## Creating the chat's state machine

A chat bot is composed of states. Let's recreate a simple one that's in our example folder. <br>
First we'll declare our initial state and functions that we'll use to create our states isoladed:

``` dart 
ChatBot(
    id: "myChatBot",
    initialStateId: "A",
    states: [
    _stateA(),
    _stateB(),
    _stateC(),
    _stateD(),
    _stateE(),
    ],
);
```
### State Types and Properties
First you should now general state properties. They will have the id, onEnter/onLeave functions, and transitions like in  <a href="https://github.com/FelipeMarra/state-composer">state_composer<a>, and generally something to show to the user and receive it's input in return.<br>
    
Currently we have 4 state types, let's add one of each in our bot.<br>

### Open Text State

State A will intruduce our bot to the user, and ask his name back. As you can see a text state type has a decideTransition propertie, wich will give you the text typed by the user so you can decide what transition to make. In our <a href="https://github.com/FelipeMarra/flutter_chat_composer/tree/main/example">example<a> we'll run _stateADecision wich will say to our machine to transition to the state ALoop till the user say his name. When the text is not empty will go to state B. Remember that a state can only transition to another that is inside it's transistion list, otherwise it will throw an error.

``` dart 
  String _stateADecision(TextEditingController textController) {
    if (textController.text.isEmpty) {
      return "ALoop";
    } else {
      userName = textController.text;
      return "B";
    }
  }

  BotStateOpenText _stateA() {
    return BotStateOpenText(
      id: "A",
      messages: () => [
        Text.rich(
          TextSpan(
            children: [
              const TextSpan(text: "Hi, I'm "),
              TextSpan(
                children: [
                  TextSpan(
                      text: botName,
                      style: const TextStyle(
                        fontWeight: FontWeight.bold,
                      )),
                ],
              ),
              const TextSpan(
                children: [
                  TextSpan(text: ", what is your name ?"),
                ],
              ),
            ],
          ),
        ),
      ],
      transitions: [
        BotTransition(id: "A=>ALoop", to: "ALoop"),
        BotTransition(id: "A=>B", to: "B"),
      ],
      decideTransition: _stateADecision,
    );
  }

  BotStateOpenText _stateALoop() {
    return BotStateOpenText(
      id: "ALoop",
      messages: () => [
        const Text.rich(
          TextSpan(
            children: [
              TextSpan(text: "I reaally nedd to know your name... "),
            ],
          ),
        ),
      ],
      transitions: [
        BotTransition(id: "ALoop=>ALoop", to: "ALoop"),
        BotTransition(id: "ALoop=>B", to: "B"),
      ],
      decideTransition: (textController) {
        if (textController.text.isEmpty) {
          return "ALoop";
        } else {
          userName = textController.text;
          return "B";
        }
      },
    );
  }
```

<img src="https://media.giphy.com/media/mnLsC3qgROE4ClDiBb/giphy.gif" width="360" height="400" />

### Single Choice State
State B will use `BotStateSingleChoice` to make the user choose a pokemon gif that will be shown in state C. When the option is selected `onChange` function will be executed followed by the transition to the next state decided by the `decideTransition` callback, that will give you the selected option and ask a state id in return - that id must me in your transitions list.
``` dart 
  BotStateSingleChoice _stateB() {
    return BotStateSingleChoice(
      id: "B",
      messages: () => [
        Text.rich(
          TextSpan(text: "Ok, $userName what pokemon would you choose"),
        )
      ],
      options: [
        BotOption(
          message: const Text("Bulbassaur"),
          onChange: (option) => choosenPokemonGif =
              "https://i.pinimg.com/originals/62/a6/94/62a694968a8a3a1842c4b9a79d5aa5c1.gif",
        ),
        BotOption(
          message: const Text("Charmander"),
          onChange: (option) => choosenPokemonGif =
              "https://i.pinimg.com/originals/37/08/62/370862bbff7f3d3345a3d0e9b45a38c3.gif",
        ),
        BotOption(
          message: const Text("Squirtle"),
          onChange: (option) => choosenPokemonGif =
              "https://i.pinimg.com/originals/24/e2/e7/24e2e7c933f4f0f11dac65521a9c4a29.gif",
        ),
      ],
      transitions: [
        BotTransition(id: "B=>C", to: "C"),
      ],
      decideTransition: (BotOption selectedOptions) => "C",
    );
  }
```
### Image State
State C will show the image and transition to the next state after 1 second <br>
Ps: had to run `flutter run -d chrome --web-renderer html` so that Image.network could display the gifs
``` dart 
  BotStateImage _stateC() {
    return BotStateImage(
      id: "C",
      image: () => Image.network(choosenPokemonGif),
      onEnter: (machine) async {
        await Future.delayed(const Duration(seconds: 1));
        machine.transitionTo("D");
      },
      transition: BotTransition(id: "C=>D", to: "D"),
    );
  }
```
<img src="https://media.giphy.com/media/ESBP6YjcOjfD8miR0G/giphy.gif" width="360" height="400" />

### Multiple Choice State
What about beeing allowed to choose more than one option? Presenting the Multiple Choice State. State D will use it to ask a little bit more about the user's pokemon taste
``` dart

```

### Single Choice Without Transition

## Creating the UI

UI is created using the `ChatBotWidget`, it already comes with predefined widgets to show everything you need, but you can customize all of them.

``` dart 
class ChatBotInteractionApp extends StatelessWidget {
  const ChatBotInteractionApp({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    ChatBot chatBot = MyChatBot().chatBot();
    return MaterialApp(
      home: Scaffold(
        appBar: AppBar(
          title: const Text("My ChatBot"),
          centerTitle: true,
        ),
        body: ChatBotWidget(
          chatBot: chatBot,
          sameUserSpacing: 3,
        ),
      ),
    );
  }
}
```
The parametters are:

...
